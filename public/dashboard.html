<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVR Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f1f3f6;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s;
        }
        .navbar {
            background: linear-gradient(90deg, #212529, #343a40);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 400px));
            gap: 1.5rem;
        }
        .camera-card {
            border-radius: 1rem;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s;
            display: flex;
            flex-direction: column;
        }
        .camera-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 18px rgba(0,0,0,0.15);
        }
        .camera-header {
            padding: .75rem 1rem;
            background: linear-gradient(90deg, #495057, #212529);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .camera-header-title {
            flex-grow: 1;
        }
        .camera-body {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 16 / 9; 
            overflow: hidden;
            transition: aspect-ratio 0.3s ease;
        }
        .camera-body iframe {
            width: 100%;
            height: 100%;
            display: block;
        }
        .camera-status {
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: auto;
            margin-right: 0.5rem;
        }
        .status-loading { background: rgba(255, 193, 7, 0.9); color: #212529; }
        .status-connected { background: rgba(25, 135, 84, 0.9); color: #fff; }
        .status-disconnected { background: rgba(220, 53, 69, 0.9); color: #fff; }
        .fullscreen-button {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            line-height: 1.5;
        }
        .fullscreen-button:hover { background-color: rgba(255, 255, 255, 0.1); }

        /* Dark mode */
        body.dark { background: #212529; color: #f8f9fa; }
        body.dark .camera-card { background: #2c2f33; }
        body.dark .alert-info { background-color: #1a1d20; color: #f8f9fa; border-color: #343a40; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
          <a class="navbar-brand fw-bold" href="/">📹 NVR</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
              <li class="nav-item"><a class="nav-link active" aria-current="page" href="/dashboard">Dashboard</a></li>
              <li class="nav-item"><a class="nav-link" href="/manage-cameras">Camera Manager</a></li>
              <li class="nav-item"><a class="nav-link" href="/playback">Playback</a></li>
            </ul>
            <ul class="navbar-nav">
              <li class="nav-item">
                <button id="dark-toggle" class="btn btn-outline-light">
                  <i class="bi bi-moon-fill"></i>
                </button>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/logout">Logout</a>
              </li>
            </ul>
          </div>
        </div>
    </nav>
    <div class="container my-4"><div id="camera-grid" class="camera-grid"></div></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const grid = document.getElementById('camera-grid');
        const iframes = {};
        const lastHeartbeat = {};
        const darkToggle = document.getElementById('dark-toggle');
        const body = document.body;

        // --- Dark Mode Logic ---
        const setCookie = (name, value, days) => {
            let expires = "";
            if (days) {
                const date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "") + expires + "; path=/";
        }
        const getCookie = (name) => {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        const applyTheme = () => {
            const theme = getCookie('theme');
            const icon = darkToggle.querySelector('i');
            if (theme === 'dark') {
                body.classList.add('dark');
                icon.classList.remove('bi-moon-fill');
                icon.classList.add('bi-sun-fill');
            } else {
                body.classList.remove('dark');
                icon.classList.remove('bi-sun-fill');
                icon.classList.add('bi-moon-fill');
            }
        }

        darkToggle.addEventListener('click', () => {
            body.classList.toggle('dark');
            const isDark = body.classList.contains('dark');
            setCookie('theme', isDark ? 'dark' : 'light', 365);
            applyTheme();
        });

        applyTheme();
        // --- End Dark Mode Logic ---

        let hiddenActiveCameraIds = [];

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                hiddenActiveCameraIds = Object.keys(iframes);
                hiddenActiveCameraIds.forEach(id => stopPlayer(id));
            } else {
                if (hiddenActiveCameraIds.length > 0) {
                    hiddenActiveCameraIds.forEach(id => startPlayer(id));
                    hiddenActiveCameraIds = [];
                }
            }
        });

        window.addEventListener('message', (event) => {
            if (event.origin !== window.location.origin) return;
            const data = event.data;

            if (data.type === 'reload' && data.cameraId) {
                stopPlayer(data.cameraId);
                startPlayer(data.cameraId);
            }
            if (data.type === 'resolution' && data.cameraId && data.width && data.height) {
                const container = document.getElementById(`camera-container-${data.cameraId}`);
                if (container) {
                    const newAspectRatio = data.width / data.height;
                    container.style.aspectRatio = newAspectRatio;
                }
            }
        });

                const startPlayer = (cameraId) => {
            if (iframes[cameraId]) return;
            const container = document.getElementById(`camera-container-${cameraId}`);
            if (!container) return;

            const card = container.closest('.camera-card');
            const statusEl = card.querySelector('.camera-status');
            statusEl.textContent = "Loading...";
            statusEl.className = "camera-status status-loading";

            const iframe = document.createElement('iframe');
            iframe.src = 'dash-player.html?cam=' + cameraId;
            iframe.allow = "fullscreen";
            iframe.style.border = '0';

            iframe.onload = () => {
                lastHeartbeat[cameraId] = Date.now();
                statusEl.textContent = "Connected";
                statusEl.className = "camera-status status-connected";
            };

            container.appendChild(iframe);
            iframes[cameraId] = iframe;
        };

        const stopPlayer = (cameraId) => {
            const iframe = iframes[cameraId];
            if (iframe) {
                iframe.remove();
                delete iframes[cameraId];
                delete lastHeartbeat[cameraId];
                const container = document.getElementById(`camera-container-${cameraId}`);
                if (container) {
                    const card = container.closest('.camera-card');
                    const statusEl = card.querySelector('.camera-status');
                    statusEl.textContent = "Disconnected";
                    statusEl.className = "camera-status status-disconnected";
                    container.style.aspectRatio = '16 / 9';
                }
            }
        };

        const toggleFullscreen = (cameraId) => {
            const iframe = iframes[cameraId];
            if (!iframe) return;
            if (!document.fullscreenElement) {
                if (iframe.requestFullscreen) iframe.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        };

        try {
            const response = await fetch('/api/cameras');
            const cameras = await response.json();
            if (!cameras || cameras.length === 0) {
                grid.innerHTML = `<div class="alert alert-info">No cameras found.</div>`;
                return;
            }
            grid.innerHTML = '';
            cameras.forEach(camera => {
                const card = document.createElement('div');
                card.className = "camera-card";
                card.innerHTML = `
                    <div class="camera-header">
                        <span class="camera-header-title">${camera.name}</span>
                        <span class="camera-status status-disconnected">Disconnected</span>
                        <button class="fullscreen-button" data-camera-id="${camera.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/></svg>
                        </button>
                    </div>
                    <div class="camera-body" id="camera-container-${camera.id}"></div>
                `;
                grid.appendChild(card);
                card.querySelector('.fullscreen-button').addEventListener('click', (e) => {
                    toggleFullscreen(e.currentTarget.dataset.cameraId);
                });
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const cameraId = entry.target.querySelector('.camera-body').id.split('-')[2];
                    if (entry.isIntersecting) startPlayer(cameraId);
                    else stopPlayer(cameraId);
                });
            }, { threshold: 0.1 });

            document.querySelectorAll('.camera-card').forEach(card => observer.observe(card));
        } catch (err) {
            console.error("Failed to load cameras:", err);
            grid.innerHTML = `<div class="alert alert-danger">❌ Failed to load camera list</div>`;
        }
    });
    </script>

</body>
</html>