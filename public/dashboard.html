<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVR Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f1f3f6;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s;
        }

        .navbar {
            background: linear-gradient(90deg, #212529, #343a40);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }

        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            justify-content: center;
        }

        .camera-card {
            border-radius: 1rem;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s;
            display: flex;
            flex-direction: column;
        }

        .camera-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.15);
        }

        .camera-header {
            padding: .75rem 1rem;
            background: linear-gradient(90deg, #495057, #212529);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .camera-header-title {
            flex-grow: 1;
        }

        .camera-body {
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 16 / 9;
            overflow: hidden;
            transition: aspect-ratio 0.3s ease;
        }

        .camera-body iframe {
            width: 100%;
            height: 100%;
            display: block;
        }

        .camera-status {
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: auto;
            margin-right: 0.5rem;
        }

        .status-loading {
            background: rgba(255, 193, 7, 0.9);
            color: #212529;
        }

        .status-connected {
            background: rgba(25, 135, 84, 0.9);
            color: #fff;
        }

        .status-disconnected {
            background: rgba(220, 53, 69, 0.9);
            color: #fff;
        }

        .status-disabled {
            background: rgba(108, 117, 125, 0.9);
            color: #fff;
        }

        .fullscreen-button {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.75rem;
            line-height: 1.5;
        }

        .fullscreen-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Dark mode */
        body.dark {
            background: #212529;
            color: #f8f9fa;
        }

        body.dark .camera-card {
            background: #2c2f33;
        }

        body.dark .alert-info {
            background-color: #1a1d20;
            color: #f8f9fa;
            border-color: #343a40;
        }

        body.dark .card {
            background-color: #2c2f33;
        }

        body.dark .form-check-label {
            color: #f8f9fa;
        }

        body.dark .dropdown-menu {
            background-color: #343a40;
            border-color: rgba(255, 255, 255, 0.15);
        }

        body.dark .dropdown-menu .form-check-label {
            color: #f8f9fa;
        }

        body.dark .dropdown-menu .dropdown-item:hover {
            background-color: #495057;
        }

        body.dark .dropdown-divider {
            border-top-color: rgba(255, 255, 255, 0.15);
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">üìπ NVR</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="/manage-cameras">Camera Manager</a></li>
                    <li class="nav-item"><a class="nav-link" href="/playback">Playback</a></li>
                    <li class="nav-item"><a class="nav-link" href="/settings">Settings</a></li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <button id="dark-toggle" class="btn btn-outline-light">
                            <i class="bi bi-moon-fill"></i>
                        </button>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container my-4">
        <div class="d-flex justify-content-end mb-3" id="filter-container" style="display: none;">
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="camera-filter-dropdown"
                    data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                    Filter Cameras
                </button>
                <ul class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="camera-filter-dropdown"
                    id="camera-filter-menu">
                    <!-- Dropdown items will be injected here by JS -->
                </ul>
            </div>
        </div>
        <div id="camera-grid" class="camera-grid"></div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const grid = document.getElementById('camera-grid');
            const filterContainer = document.getElementById('filter-container');
            const dropdownMenu = document.getElementById('camera-filter-menu');
            const dropdownButton = document.getElementById('camera-filter-dropdown');
            const iframes = {};
            const lastHeartbeat = {};
            const darkToggle = document.getElementById('dark-toggle');
            const body = document.body;

            // --- Cookie and Theme Logic ---
            const setCookie = (name, value, days) => {
                let expires = "";
                if (days) {
                    const date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toUTCString();
                }
                document.cookie = name + "=" + (value || "") + expires + "; path=/";
            }
            const getCookie = (name) => {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for (let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }
            const applyTheme = () => {
                const theme = getCookie('theme');
                const icon = darkToggle.querySelector('i');
                if (theme === 'dark') {
                    body.classList.add('dark');
                    icon.classList.remove('bi-moon-fill');
                    icon.classList.add('bi-sun-fill');
                } else {
                    body.classList.remove('dark');
                    icon.classList.remove('bi-sun-fill');
                    icon.classList.add('bi-moon-fill');
                }
            }
            darkToggle.addEventListener('click', () => {
                body.classList.toggle('dark');
                const isDark = body.classList.contains('dark');
                setCookie('theme', isDark ? 'dark' : 'light', 365);
                applyTheme();
            });
            applyTheme();
            // --- End Cookie and Theme Logic ---

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const cameraId = entry.target.dataset.cameraId;
                    if (entry.isIntersecting) startPlayer(cameraId);
                    else stopPlayer(cameraId);
                });
            }, { threshold: 0.1 });

            // --- Camera Filtering Logic ---
            const updateDropdownButtonText = () => {
                const cameraCheckboxes = dropdownMenu.querySelectorAll('input[type="checkbox"]:not(#select-all-cameras)');
                const checkedCount = Array.from(cameraCheckboxes).filter(cb => cb.checked).length;

                if (checkedCount === 0) {
                    dropdownButton.textContent = 'No Cameras Selected';
                } else if (checkedCount === cameraCheckboxes.length) {
                    dropdownButton.textContent = 'All Cameras Selected';
                } else {
                    dropdownButton.textContent = `${checkedCount} Camera(s) Selected`;
                }
            };

            const updateSelectAllState = () => {
                const selectAllCheckbox = document.getElementById('select-all-cameras');
                if (!selectAllCheckbox) return;
                const cameraCheckboxes = dropdownMenu.querySelectorAll('input[type="checkbox"]:not(#select-all-cameras)');
                const checkedCount = Array.from(cameraCheckboxes).filter(cb => cb.checked).length;
                selectAllCheckbox.checked = cameraCheckboxes.length > 0 && checkedCount === cameraCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < cameraCheckboxes.length;
            };

            const saveCameraSelection = () => {
                const visibleCameras = Array.from(dropdownMenu.querySelectorAll('input[type="checkbox"]:not(#select-all-cameras):checked'))
                    .map(input => input.dataset.cameraId);
                setCookie('visibleCameras', visibleCameras.join(','), 365);
            };

            const filterCameraGrid = () => {
                const visibleCamerasCookie = getCookie('visibleCameras');
                const visibleCameras = (visibleCamerasCookie || '').split(',').filter(Boolean);

                document.querySelectorAll('.camera-card').forEach(card => {
                    const cardCameraId = card.dataset.cameraId;
                    if (visibleCameras.includes(cardCameraId)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                        stopPlayer(cardCameraId);
                    }
                });
                observer.disconnect();
                document.querySelectorAll('.camera-card').forEach(card => {
                    if (card.style.display !== 'none') {
                        observer.observe(card);
                    }
                });
            };

            let hiddenActiveCameraIds = [];
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    hiddenActiveCameraIds = Object.keys(iframes);
                    hiddenActiveCameraIds.forEach(id => stopPlayer(id));
                } else {
                    if (hiddenActiveCameraIds.length > 0) {
                        hiddenActiveCameraIds.forEach(id => startPlayer(id));
                        hiddenActiveCameraIds = [];
                    }
                }
            });

            window.addEventListener('message', (event) => {
                if (event.origin !== window.location.origin) {
                    // Also allow messages from remote nodes if they are in federation
                    if (!allCameras.some(c => c.nodeUrl && event.origin === c.nodeUrl)) return;
                }
                const data = event.data;
                if (data.type === 'reload' && data.cameraId) {
                    stopPlayer(data.cameraId);
                    startPlayer(data.cameraId);
                }
                if (data.type === 'resolution' && data.cameraId && data.width && data.height) {
                    const container = document.getElementById(`camera-container-${data.cameraId}`);
                    if (container) {
                        const newAspectRatio = data.width / data.height;
                        container.style.aspectRatio = newAspectRatio;
                    }
                }
            });

            const startPlayer = (cameraId) => {
                if (iframes[cameraId]) return;
                const container = document.getElementById(`camera-container-${cameraId}`);
                if (!container) return;
                const card = container.closest('.camera-card');
                if (card.style.display === 'none' || card.classList.contains('disabled-cam')) return;

                // Find camera data
                const camera = allCameras.find(c => String(c.id) === String(cameraId));
                if (!camera) return;

                const statusEl = card.querySelector('.camera-status');
                statusEl.textContent = "Loading...";
                statusEl.className = "camera-status status-loading";
                const iframe = document.createElement('iframe');

                // If remote, use the remote server's player directly
                if (camera.isRemote && camera.nodeUrl) {
                    // We need to strip the prefix 'remote_...' to get the original ID for the remote server
                    const originalId = String(camera.id).split('_').pop();
                    const playerPage = camera.stream_method === 'jsmpeg' ? 'jsmpeg-player.html' : 'dash-player.html';
                    iframe.src = `${camera.nodeUrl}/${playerPage}?cam=${originalId}`;
                } else {
                    const playerPage = camera.stream_method === 'jsmpeg' ? 'jsmpeg-player.html' : 'dash-player.html';
                    iframe.src = `${playerPage}?cam=${cameraId}`;
                }

                iframe.allow = "fullscreen";
                iframe.style.border = '0';
                iframe.onload = () => {
                    lastHeartbeat[cameraId] = Date.now();
                    statusEl.textContent = "Connected";
                    statusEl.className = "camera-status status-connected";
                };
                container.appendChild(iframe);
                iframes[cameraId] = iframe;
            };

            const stopPlayer = (cameraId) => {
                const iframe = iframes[cameraId];
                if (iframe) {
                    iframe.remove();
                    delete iframes[cameraId];
                    delete lastHeartbeat[cameraId];
                    const container = document.getElementById(`camera-container-${cameraId}`);
                    if (container) {
                        const card = container.closest('.camera-card');
                        const statusEl = card.querySelector('.camera-status');
                        statusEl.textContent = "Disconnected";
                        statusEl.className = "camera-status status-disconnected";
                        container.style.aspectRatio = '16 / 9';
                    }
                }
            };

            const toggleFullscreen = (cameraId) => {
                const iframe = iframes[cameraId];
                if (iframe && iframe.contentWindow) {
                    // Send a message to the player inside the iframe
                    iframe.contentWindow.postMessage({ type: 'requestFullscreen' }, "*");
                } else {
                    console.error('Could not find iframe or content window for camera:', cameraId);
                }
            };

            let allCameras = [];

            try {
                const response = await fetch('/api/cameras');
                const cameras = await response.json();
                allCameras = cameras;
                if (!cameras || cameras.length === 0) {
                    grid.innerHTML = `<div class="alert alert-info w-100" role="alert">No cameras have been added. Go to the <a href="/manage-cameras" class="alert-link">Camera Manager</a> to add one.</div>`;
                    return;
                }

                filterContainer.style.display = 'flex'; // Show the filter button

                const visibleCamerasCookie = getCookie('visibleCameras');
                const visibleCameras = (visibleCamerasCookie || '').split(',').filter(Boolean);

                // Build Dropdown Menu
                dropdownMenu.innerHTML = ''; // Clear previous items

                // 1. Add "Select All"
                const selectAllLi = document.createElement('li');
                selectAllLi.innerHTML = `
                <div class="dropdown-item">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="select-all-cameras">
                        <label class="form-check-label fw-bold" for="select-all-cameras">Show All Cameras</label>
                    </div>
                </div>`;
                dropdownMenu.appendChild(selectAllLi);

                // 2. Add Divider
                dropdownMenu.appendChild(document.createElement('hr'));

                // 3. Add Camera Items
                cameras.forEach(camera => {
                    const isChecked = visibleCameras.includes(String(camera.id));
                    const li = document.createElement('li');
                    const label = camera.isRemote ? `${camera.name} (${camera.nodeLabel})` : camera.name;
                    li.innerHTML = `
                    <div class="dropdown-item">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="cam-check-${camera.id}" data-camera-id="${camera.id}" ${isChecked ? 'checked' : ''}>
                            <label class="form-check-label" for="cam-check-${camera.id}">${label}</label>
                        </div>
                    </div>`;
                    dropdownMenu.appendChild(li);
                });

                // Add event listeners after creating all elements
                const selectAllCheckbox = document.getElementById('select-all-cameras');
                selectAllCheckbox.addEventListener('change', () => {
                    const isChecked = selectAllCheckbox.checked;
                    dropdownMenu.querySelectorAll('input[type="checkbox"]:not(#select-all-cameras)').forEach(cb => {
                        cb.checked = isChecked;
                    });
                    saveCameraSelection();
                    filterCameraGrid();
                    updateDropdownButtonText();
                });

                dropdownMenu.querySelectorAll('input[type="checkbox"]:not(#select-all-cameras)').forEach(cb => {
                    cb.addEventListener('change', () => {
                        updateSelectAllState();
                        saveCameraSelection();
                        filterCameraGrid();
                        updateDropdownButtonText();
                    });
                });

                // Build Camera Grid
                grid.innerHTML = '';
                cameras.forEach(camera => {
                    const isDisabled = camera.enabled === false;
                    const card = document.createElement('div');
                    card.className = "camera-card" + (isDisabled ? " disabled-cam" : "");
                    if (isDisabled) card.style.opacity = '0.6';
                    card.dataset.cameraId = camera.id;

                    const statusText = isDisabled ? "Disabled" : "Disconnected";
                    const statusClass = isDisabled ? "status-disabled" : "status-disconnected";
                    const nodeBadge = camera.isRemote ? `<span class="badge bg-primary ms-2" style="font-size: 0.6rem;">${camera.nodeLabel}</span>` : "";
                    const fullscreenBtn = isDisabled ? "" : `
                        <button class="fullscreen-button" data-camera-id="${camera.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096-4.096a.5.5 0 0 1 0 .707z"/></svg>
                        </button>`;

                    card.innerHTML = `
                    <div class="camera-header">
                        <span class="camera-header-title text-truncate">${camera.name} ${nodeBadge}</span>
                        <span class="camera-status ${statusClass}">${statusText}</span>
                        ${fullscreenBtn}
                    </div>
                    <div class="camera-body" id="camera-container-${camera.id}">
                        ${isDisabled ? '<div class="text-white small">Camera is disabled</div>' : ''}
                    </div>
                `;
                    grid.appendChild(card);
                    const fsBtn = card.querySelector('.fullscreen-button');
                    if (fsBtn) {
                        fsBtn.addEventListener('click', (e) => {
                            toggleFullscreen(e.currentTarget.dataset.cameraId);
                        });
                    }
                });

                // Initial UI update
                updateSelectAllState();
                filterCameraGrid();
                updateDropdownButtonText();

            } catch (err) {
                console.error("Failed to load cameras:", err);
                grid.innerHTML = `<div class="alert alert-danger w-100" role="alert">‚ùå Failed to load camera list. Error: ${err.message}</div>`;
            }
        });
    </script>

</body>

</html>